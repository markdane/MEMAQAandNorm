---
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)
```


```{r, echo=FALSE}
#Author: Mark Dane, copyright 2015

plotLEHmap <- function(dt, fill, titleExpression){
  p <- ggplot(dt, aes_string(x="Ligand", y="ECMp", fill = fill))+
    geom_tile()+
    scale_fill_gradient(low="white",high="red",oob = scales::squish,
                        limits=(quantile(dt[[fill]], probs=c(.01, .99), na.rm=TRUE)))+
    ggtitle(titleExpression)+
    xlab("")+ylab("")+
    guides(fill=FALSE)+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.7)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.7)),panel.grid.major = element_line(linetype = 'blank'),panel.background = element_rect(fill = "dimgray"))
  suppressWarnings(print(p))
}

source("MEPLINCSFunctions.R")
supportingPlots = FALSE
runRUV2S = TRUE

#Set the staining set to be analyzed (SS1|SS2|SS3)
ss <- "SS2"
#Set the cell line to be analyzed (PC3|MCF7|YAPC)
cellLine <- "PC3"
```



```{r setup}
library("ggplot2")
library("data.table")
library("limma")
library("MEMA")
library("grid")
library(knitr)
library("gplots")
library("RColorBrewer")
library("RUVnormalize")


#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)

l1 <- fread(paste0("./",cellLine,"/",ss,"/AnnotatedData/",cellLine,"_",ss,"_Level1.txt"), showProgress = FALSE)

#Keep the control wells separate
l1$Ligand[l1$Ligand=="FBS"] <- paste(l1$Ligand[l1$Ligand=="FBS"],"C",as.numeric(factor(l1$Barcode[l1$Ligand=="FBS"])),sep="")
l1$MEP <- paste(l1$ECMp,l1$Ligand,sep="_")
setkey(l1, "ECMp")
l1 <- l1[!"fiducial"]
l1 <- l1[!"blank"]

#Logit transform DNA2NProportion
#logit(p) = log[p/(1-p)]
DNA2NImpute <- l1$Nuclei_PA_Cycle_DNA2NProportion
DNA2NImpute[DNA2NImpute==0] <- .01
DNA2NImpute[DNA2NImpute==1] <- .99
l1$Nuclei_PA_Cycle_DNA2NProportionLogit <- log2(DNA2NImpute/(1-DNA2NImpute))


#Create spot level dataset
l3 <- l1[,list(Ligand=unique(Ligand), LigandAnnotID=unique(LigandAnnotID),
               ECMp=unique(ECMp), ECMpAnnotID=unique(ECMpAnnotID),
               MEP=unique(MEP),
               Row=unique(Row), Column = unique(Column), Block=unique(Block), ID=unique(ID),
               ArrayRow=unique(ArrayRow), ArrayColumn=unique(ArrayColumn),
               mel = median(Nuclei_PA_Gated_EduPositiveLogit, na.rm=TRUE),
               DNA2Nmel = median(Nuclei_PA_Cycle_DNA2NProportionLogit, na.rm=TRUE),
               SCCmel = as.numeric(median(Spot_PA_SpotCellCount, na.rm=TRUE))),
         by="Barcode,Well,Spot"]
#Create random sample sets
set.seed(1234)
l3 <-l3[,Sample := sample(1:.N, .N, replace=FALSE), by=MEP]

l1MEPs <- l1[,list(mel = median(Nuclei_PA_Gated_EduPositiveLogit, na.rm = TRUE),
                   Mel = mad(Nuclei_PA_Gated_EduPositiveLogit, na.rm= TRUE),
                   melPP = median(Nuclei_PA_Gated_EduPositiveProportion, na.rm = TRUE),
                   MelPP = mad(Nuclei_PA_Gated_EduPositiveProportion, na.rm= TRUE)),
             by="Barcode,Well,Ligand,ECMp,MEP"]
```

```{r RUV2+Shrinkage, eval=runRUV2S}

runNaiveRUV2S <- function(nu, Y, cIdx, k){
  nY <- naiveRandRUV(Y, cIdx, nu, k)
  #Median summarize the normalized values
  nYm <- apply(nY,2, median, na.rm=TRUE)
  #Create a data.table
  nYm <- data.table(mel=nYm, MEP=names(nYm), Mel=apply(nY,2, mad, na.rm=TRUE))
  nYm$ECMp <- strsplit2(nYm$MEP, split="_")[,1]
  nYm$Ligand <- sub("[[:alnum:]]*_","",nYm$MEP)
  return(nYm)
}

#Randomly sample 8 replicates of each MEP type 
nrReps <- 8
Y <- setkey(l3[l3$Sample <= nrReps], Sample,MEP)

#Unit of study is array
Y <- matrix(Y$mel, nrow=nrReps, byrow=TRUE, dimnames=list(paste0("Sample",1:nrReps),Y$MEP[Y$Sample==1] ))
k <- nrow(Y)
cIdx <- 1:ncol(Y)
nu <- 1e-2

#Normalize the set of replicate samples
nsY <- runNaiveRUV2S(nu, Y, cIdx, k)

```
---
title: "MEP-LINCS `r cellLine` `r ss` Quality Analysis"
date: "`r Sys.Date()`"
---

###Introduction
The LINCS Pilot `r cellLine` `r ss` experiment was performed with cells grown in eight 8-well plates. The `r ss` staining set includes, DAPI, `r unique(l1$Endpoint488)` (488nm), `r unique(l1$Endpoint555)` (555nm) and `r unique(l1$Endpoint647)` (647nm). Four color images of the cells at each spot were gathered on a Nikon automated microscope. All data for this staining set comes from the nuclei as defined by the DAPI staining.

Intensity, position and a limited set of morphology data are gathered for each cell, merged with the experiment metadata, normalized, filtered and summarized. The dataset is organized into the four LINCS imaging categories as follows:

Level 1 - Raw data  
Level 2 - Normalized data  
Level 3 - Normalized data aggregated to the spot level  
Level 4 - Normalized data aggregated to the replicate (MEP) level  

The data merging and analysis is done in R using open source software. 

###Proliferation Analysis
This analysis starts with a focus on the proportion of EdU positive cells at each spot.
For each plate, k-means clustering (k = 2) is used on the raw EdU median intensity values of the cells in the control well. Cells in the higher-value cluster are labeled as EdU+.  
The intensity value dividing the control well clusters is used as a threshold to label the cells in the other 7 ligand wells of the plate.  
The proportion of EdU+ cells at each spot is calculated.  
The proportion is transformed by the logit function defined as logit(p) = log2(p/1-p) which takes on values from negative to positive infinity. The proportion values in this dataset have been transformed into the range [.01, .99] to eliminate issues with infinite values.


```{r, eval=TRUE, fig.width=9, fig.height=6}

titleExpression <- expression(EdU^{"+"}~ Medians~(m["e,l"]))
plotLEHmap(l1MEPs, fill="mel", titleExpression)

titleExpression <- expression(EdU^{"+"}~MADs~(M["e,l"]))
plotLEHmap(l1MEPs, fill="Mel", titleExpression)


```


```{r, eval=TRUE, fig.width=9, fig.height=6}


for(nu in c(0, 1e-2, 1e-1, 1, 10)){
  titleExpression <- bquote(EdU^{"+"}~ Medians~(m["e,l"])~RUV~with~Shrinkage~nu~"=" ~.(nu))
  nsY <- runNaiveRUV2S(nu, Y, cIdx, k)
  plotLEHmap(dt=nsY, fill="mel", titleExpression)
}

for(nu in c(0, 1e-2, 1e-1, 1, 10)){
  titleExpression <- bquote(EdU^{"+"}~ MADs~(M["e,l"])~RUV~with~Shrinkage~nu~"=" ~.(nu))
  nsY <- runNaiveRUV2S(nu, Y, cIdx, k)
  plotLEHmap(dt=nsY, fill="Mel", titleExpression)
}

```

```{r AddMarginValues}

l1MEPs.l <- l1MEPs[,list(m.l = median(mel, na.rm = TRUE),
                         M.l = median(Mel, na.rm= TRUE),
                         m.lPP = median(melPP, na.rm = TRUE),
                         M.lPP = median(MelPP, na.rm= TRUE)),
                   by="Ligand"]

l1MEPse. <- l1MEPs[,list(me. = median(mel, na.rm = TRUE),
                         Me. = median(Mel, na.rm= TRUE),
                         me.PP = median(melPP, na.rm = TRUE),
                         Me.PP = median(MelPP, na.rm= TRUE)),
                   by="ECMp"]

setkey(l1MEPs,Ligand)
setkey(l1MEPs.l,Ligand)
l1MEPs <- merge(l1MEPs,l1MEPs.l)

setkey(l1MEPs,ECMp)
setkey(l1MEPse.,ECMp)
l1MEPs <- merge(l1MEPs, l1MEPse.)  

m.. <- median(l1MEPs$mel, na.rm = TRUE)
M.. <- median(l1MEPs$Mel, na.rm = TRUE)

```  

###Centered Medians by ECM Protein
Each boxplot below has 64 logit-transformed EdU+ proportion values that are the medians from the replicates of pairing one ECMp with each of the 64 ligands and then subtracting the median of pairing all ECM proteins with each ligand.


```{r, fig.height=4}
p <- ggplot(l1MEPs,aes(x=ECMp, y=mel-m.l))+
  geom_boxplot()+ 
  ggtitle(expression(EdU^{"+"}~Centered~Medians~by~ECMp~(m["e,l"]*"-"*m[".,l"])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))

```

###Centered Medians by Ligand
Each boxplot below has 46 logit-transformed EdU+ proportion values that are the medians from the replicates of pairing one ligand with each of the 46 ECM proteins and then subtracting the the median of pairing all ligands with each ECM protein.

```{r, fig.height=4}

p <- ggplot(l1MEPs,aes(x=Ligand, y=mel-me.))+
  geom_boxplot()+ ggtitle(expression(EdU^{"+"}~Centered~ Medians~by~Ligand~(m["e,l"]*"-"*m["e,."])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
suppressWarnings(print(p))


p <- ggplot(l1MEPs,aes(x=Barcode, y=mel-me., colour=Well))+
  geom_boxplot()+ ggtitle(expression(EdU^{"+"}~Centered~ Medians~by~Ligand~(m["e,l"]*"-"*m["e,."])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
suppressWarnings(print(p))

```


###Centered MADs
The MADs are centered in the same manner as the medians.  

```{r, fig.height=4}

p <- ggplot(l1MEPs,aes(x=ECMp, y=Mel-M.l))+
  geom_boxplot()+ 
  ggtitle(expression(EdU^{"+"}~Centered~MADs~by~ECMp~(M["e,l"]*"-"*M[".,l"])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
suppressWarnings(print(p))

p <- ggplot(l1MEPs,aes(x=Ligand, y=Mel-Me.))+
  geom_boxplot()+ ggtitle(expression(EdU^{"+"}~Centered~MADs~by~Ligand~(M["e,l"]*"-"*M["e,."])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
suppressWarnings(print(p))

p <- ggplot(l1MEPs,aes(x=Barcode, y=Mel-Me.,colour=Well))+
  geom_boxplot()+ ggtitle(expression(EdU^{"+"}~Centered~MADs~by~Ligand~(M["e,l"]*"-"*M["e,."])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
suppressWarnings(print(p))

```


###Median MAD Values
Histograms of the median MADs of the logit(EdU+ proportion) stratified by ligand and then by ECMp are shown below. The median MAD (M.,.) of all ECMp and ligand pairings is `r sprintf( "%.2f",M..)`.

```{r, fig.height=3}

p <- ggplot(l1MEPse., aes(x=Me.))+
  geom_bar(binwidth=.05)+
  xlab("Median MAD")+xlim(0,3)+
  ggtitle(expression(Histogram~of~EdU^{"+"}~ Medians~of~MADs~by~ECMp~(M["e,."])))
print(p)

p <- ggplot(l1MEPs.l, aes(x=M.l))+
  geom_bar(binwidth=.05)+
  xlab("Median MAD")+xlim(0,3)+
  ggtitle(expression(Histogram~of~EdU^{"+"}~ Medians~of~MADs~by~Ligand~(M[".,l"])))
print(p)
```


###Variability Across Plates in the Staining Set

```{r}
cMEPs <- l1MEPs[l1MEPs$Well=="A03"]
cMEPECMp <- cMEPs[,list(ce=median(mel, na.rm=TRUE),
                        Ce=mad(mel, na.rm=TRUE),
                        cePP=median(melPP, na.rm=TRUE),
                        CePP=mad(melPP, na.rm=TRUE)),by=ECMp]

lMEPs <- l1MEPs[!l1MEPs$Well=="A03"]
lMEPECMp <- lMEPs[,list(ne=median(mel, na.rm=TRUE),
                        Ne=mad(mel, na.rm=TRUE),
                        nePP=median(melPP, na.rm=TRUE),
                        NePP=mad(melPP, na.rm=TRUE)),
                  by=ECMp]
```


```{r, fig.height=4}

p <- ggplot(cMEPECMp, aes(x=Ce))+
  geom_bar(binwidth = .15)+
  xlab("MAD")+xlim(0,3)+
  ggtitle(expression(Histogram~of~EdU^{"+"}~ Control ~MADs~by~ECMp~(C["e"])))
print(p)

p <- ggplot(lMEPECMp, aes(x=Ne))+
  geom_bar(binwidth = .15)+
  xlab("MAD")+xlim(0,3)+
  ggtitle(expression(Histogram~of~EdU^{"+"}~ Ligand ~MADs~by~ECMp~(N["e"])))
print(p)

```

##Supplemental Material



###Medians by ECM Protein
Each boxplot below has 64 logit-transformed EdU+ proportion values that are the medians from the replicates of pairing one ECMp with each of the 64 ligands.


```{r, fig.height=4, eval=supportingPlots}
p <- ggplot(l1MEPs,aes(x=ECMp, y=mel))+
  geom_boxplot()+ 
  ggtitle(expression(EdU^{"+"}~ Medians~by~ECMp~(m["e,l"])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))

```

###Medians by Ligand
Each boxplot below has 46 logit-transformed EdU+ proportion values that are the medians from the replicates of pairing one ligand with each of the 46 ECM proteins.


```{r, fig.height=4, eval=supportingPlots}

p <- ggplot(l1MEPs,aes(x=Ligand, y=mel))+
  geom_boxplot()+ 
  ggtitle(expression(EdU^{"+"}~ Medians~by~Ligand~(m["e,l"])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))

```

###Margin Medians

Below are the margin medians by ECMp and then ligand. The blue lines are the medians of all ECMps (ligands).  
Median median m(.,l) of ligand columns is `r sprintf( "%.2f",median(l1MEPs$m.l))`
Median median m(e,.) of ECMp rows is `r sprintf( "%.2f", median(l1MEPs$me.))`
The median median (m.,.) of all ECMp and ligand pairings is `r sprintf( "%.2f", median(l1MEPs$mel))`.

```{r, fig.height=4, eval=supportingPlots}


p <- ggplot(l1MEPs,aes(x=Ligand, y=m.l))+
  geom_point()+
  geom_hline(yintercept=median(l1MEPs$m.l), colour = "blue")+
  ggtitle(expression(EdU^{"+"}~Medians~by~Ligand~(m[".,l"])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))


p <- ggplot(l1MEPs,aes(x=ECMp, y=me.))+
  geom_point()+
  geom_hline(yintercept=median(l1MEPs$me.), colour = "blue")+
  ggtitle(expression(EdU^{"+"}~Medians~by~ECMp~(m["e,."])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))

```


###MADs by ECM Protein
Each boxplot below has 64 logit-transformed EdU+ proportion values that are the MADs from the replicates of pairing one ECMp with each of the 64 ligands.


```{r, fig.height=4, eval=supportingPlots}
p <- ggplot(l1MEPs,aes(x=ECMp, y=Mel))+
  geom_boxplot()+ 
  ggtitle(expression(EdU^{"+"}~MADs~by~ECMp~(M["e,l"])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))

```

###MADs by Ligand
Each boxplot below has 46 logit-transformed EdU+ proportion values that are the MADs from the replicates of pairing one ligand with each of the 46 ECM proteins.


```{r, fig.height=4, eval=supportingPlots}
p <- ggplot(l1MEPs,aes(x=Ligand, y=Mel))+
  geom_boxplot()+ 
  ggtitle(expression(EdU^{"+"}~ MADs~by~Ligand~(M["e,l"])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))

```


###Margin MADs

Below are the margin MADs by ECMp and then ligand. The blue lines are the medians of all ECMps (ligands).  
Median MAD M(.,l) of ligand columns is `r sprintf( "%.2f", median(l1MEPs$M.l))`  
Median MAD M(e,.) of ECMp rows is `r sprintf( "%.2f", median(l1MEPs$Me.))`  
Median MAD (M.,.) of all ECMp and ligand pairings is `r sprintf( "%.2f", median(l1MEPs$Mel))`.  

```{r, fig.height=4, eval=supportingPlots}


p <- ggplot(l1MEPs,aes(x=Ligand, y=M.l))+
  geom_point()+
  geom_hline(yintercept=median(l1MEPs$M.l), colour = "blue")+
  ggtitle(expression(EdU^{"+"}~Margin~MADs~by~Ligand~(M[".,l"])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))


p <- ggplot(l1MEPs,aes(x=ECMp, y=Me.))+
  geom_point()+
  geom_hline(yintercept=median(l1MEPs$Me.), colour = "blue")+
  ggtitle(expression(EdU^{"+"}~Margin~MADs~by~ECMp~(M["e,."])))+
  xlab("")+ylab("")+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(1)))
suppressWarnings(print(p))

```



```{r, eval=supportingPlots}
#####recheck below as there may be a fault in the logic of method
lMEPs<- lMEPs[,mep := median(mel), by="Barcode,ECMp"]
lMEPs <- lMEPs[,melmepAbsDiff := abs(mel-mep), by="Barcode,ECMp"]

We <- lMEPs[,list(melmepAbsDiffMAD = median(melmepAbsDiff),
                  MelmepAbsDiffMAD = mad(melmepAbsDiff),
                  ECMp = ECMp), by="Barcode,Ligand"]

setkey(We, ECMp)
MEPECMp <- merge(cMEPECMp, We)

setnames(lMEPECMp, grep("ECMp", colnames(lMEPECMp), value=TRUE, invert=TRUE), paste0(grep("ECMp", colnames(lMEPECMp), value=TRUE, invert=TRUE),"Ligand"))
setkey(lMEPECMp, ECMp)

MEPECMp <- merge(MEPECMp,lMEPECMp)

```


```{r, fig.width=4.5, fig.height=5, eval=supportingPlots}
p <- ggplot(MEPECMp, aes(x=melECMpPlateAbsDiffMAD, y=MADMedian))+
  xlab(expression(Median~MAD~of~Absolute~Differences~of~Ligand~medians~of~EdU^{"+"}~by~ECMp~(W["e"])))+
  ylab(expression(Median~MAD~of~Control~medians~of~EdU^{"+"}~by~ECMp~(C["e"])))+
  ggtitle("Variablity of Wells within Plates")+
  geom_point()+
  theme(axis.title = element_text(size=rel(.7)),
        axis.title = element_text(size=rel(.7)))

suppressWarnings(print(p))

p <- ggplot(MEPECMp, aes(x=MADMedianLigand, y=MADMedian))+
  xlab(expression(Median~MAD~of~Ligands~and~Controls~medians~of~EdU^{"+"}~by~ECMp~(M["e"])))+
  ylab(expression(Median~MAD~of~Control~medians~of~EdU^{"+"}~by~ECMp~(C["e"])))+
  ggtitle("Variablity of Wells within Plates")+
  geom_point()+
  theme(axis.title = element_text(size=rel(.7)),
        axis.title = element_text(size=rel(.7)))

suppressWarnings(print(p))

p <- ggplot(MEPECMp, aes(y=MADMedianLigand, x=melECMpPlateAbsDiffMAD))+
  ylab(expression(Median~MAD~of~Ligands~and~Controls~medians~of~EdU^{"+"}~by~ECMp~(M["e"])))+
  xlab(expression(Median~MAD~of~Absolute~Differences~of~Ligand~medians~of~EdU^{"+"}~by~ECMp~(W["e"])))+
  ggtitle("Variablity of Wells within Plates")+
  geom_point()+
  theme(axis.title = element_text(size=rel(.7)),
        axis.title = element_text(size=rel(.7)))

suppressWarnings(print(p))

```


###Tests for Control Means as Null Means with Logit

```{r, fig.height=4, eval=supportingPlots}

p <- ggplot(cMEPECMp, aes(x=ECMp, y=ce))+
  geom_point(colour="blue")+
  ggtitle(expression(Median~of~logit(EdU^{"+"})~by~ECMp~with~Control(blue)~and~all~Ligands(red)))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
p <- p + geom_point(data=lMEPECMp, aes(y=ne), colour="red")

suppressWarnings(print(p))

p <- ggplot(cMEPECMp, aes(x=ce, y=Ce))+
  geom_point()+
  stat_smooth(method='loess')+
  ggtitle(expression(MAD~vs~Median~of~logit(EdU^{"+"})~by~ECMp~of~Control~(c["e,"]*C[e])))

suppressWarnings(print(p))

p <- ggplot(lMEPECMp, aes(x=ne, y=Ne))+
  geom_point()+
  stat_smooth(method='loess')+
  ggtitle(expression(MAD~vs~Median~of~logit(EdU^{"+"})~by~ECMp~of~Ligands~(n["e,"]*N[e])))

suppressWarnings(print(p))


```

###Tests for Control Means as Null Means with Positive Proportion

```{r, fig.height=4, eval=supportingPlots}

p <- ggplot(cMEPECMp, aes(x=ECMp, y=cePP))+
  geom_point(colour="blue")+
  ggtitle(expression(Median~of~EdU^{"+"}~Positive~Proportion~by~ECMp~with~Control(blue)~and~all~Ligands(red)))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
p <- p + geom_point(data=lMEPECMp, aes(y=ne), colour="red")

suppressWarnings(print(p))

p <- ggplot(cMEPECMp, aes(x=cePP, y=CePP))+
  geom_point()+
  stat_smooth(method='loess')+
  ggtitle(expression(MAD~vs~Median~of~EdU^{"+"}~Positive~Proportion~by~ECMp~of~Control~(c["e,"]*C[e])))

suppressWarnings(print(p))

p <- ggplot(lMEPECMp, aes(x=nePP, y=NePP))+
  geom_point()+
  stat_smooth(method='loess')+
  ggtitle(expression(MAD~vs~Median~of~EdU^{"+"}~Positive~Proportion~by~ECMp~of~Ligands~(n["e,"]*N[e])))

suppressWarnings(print(p))


```

