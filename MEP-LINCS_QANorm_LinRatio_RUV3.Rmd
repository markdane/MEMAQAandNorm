---
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)
```


```{r, echo=FALSE}
#Author: Mark Dane, copyright 2015

source("MEPLINCSFunctions.R")
supportingPlots = FALSE
runRUV2S = TRUE


```



```{r setup}
library("ggplot2")
library("reshape2")
library("data.table")
library("limma")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library("RUVnormalize")

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)

#ToDo Make changes for new folder sturcture
l1 <- fread(x[["inputFileName"]], showProgress = FALSE)

#Keep the control wells separate
l1$Ligand[l1$Ligand=="FBS"] <- paste(l1$Ligand[l1$Ligand=="FBS"],"C",as.numeric(factor(l1$Barcode[l1$Ligand=="FBS"])),sep="")
l1$MEP <- paste(l1$ECMp,l1$Ligand,sep="_")
setkey(l1, "ECMp")
l1 <- l1[!"fiducial"]
l1 <- l1[!"blank"]

#Logit transform DNA2NProportion
#logit(p) = log[p/(1-p)]
DNA2NImpute <- l1$Nuclei_PA_Cycle_DNA2NProportion
DNA2NImpute[DNA2NImpute==0] <- .01
DNA2NImpute[DNA2NImpute==1] <- .99
l1$Nuclei_PA_Cycle_DNA2NProportionLogit <- log2(DNA2NImpute/(1-DNA2NImpute))
l1$Cytoplasm_PA_Intensity_MedianIntensity_LinRatio <- log2((l1$Cytoplasm_CP_Intensity_MedianIntensity_KRT19+.001)/(l1$Cytoplasm_CP_Intensity_MedianIntensity_KRT5+.001))

#Create spot level dataset
l3 <- l1[,list(Ligand=unique(Ligand), LigandAnnotID=unique(LigandAnnotID),
               ECMp=unique(ECMp), ECMpAnnotID=unique(ECMpAnnotID),
               MEP=unique(MEP),
               Row=unique(Row), Column = unique(Column), Block=unique(Block), ID=unique(ID),
               ArrayRow=unique(ArrayRow), ArrayColumn=unique(ArrayColumn),
               LinRatiomel = median(Cytoplasm_PA_Intensity_MedianIntensity_LinRatio, na.rm=TRUE),
               DNA2Nmel = median(Nuclei_PA_Cycle_DNA2NProportionLogit, na.rm=TRUE),
               SCCmel = as.numeric(median(Spot_PA_SpotCellCount, na.rm=TRUE))
           ),
         by="Barcode,Well,Spot"]


l1MEPs <- l1[,list(mel = median(Cytoplasm_PA_Intensity_MedianIntensity_LinRatio, na.rm = TRUE),
                   Mel = mad(Cytoplasm_PA_Intensity_MedianIntensity_LinRatio, na.rm= TRUE)),
             by="Barcode,Well,Ligand,ECMp,MEP"]

#l1MEPS is the data.table of the MEP level, raw, log2-transformed LinRatio responses
l1MEPs <- addMarginValues(l1MEPs,"mel","Mel")

#calculate the overall median and MAD for the staining set
m.. <- median(l1MEPs$mel, na.rm = TRUE)
M.. <- median(l1MEPs$Mel, na.rm = TRUE)
```

```{r RUVIII, eval=TRUE}
#Order the spot level data by plate, well, spot number
#Create a spot assignment that works with rotated B row arrays
#RUV-III without the final step of averaging. 
#k=0,1, 2, 3, 4 say
#treat plates as units 
#neg controls from control ligand
#view all 8 plates as replicates.
#M would be a m by 1 matrix of all 1s, where m is the number of rows of Y.  
#keep k very small.

l3$RSpot <- l3$Spot
l3$RSpot[grepl("B",l3$Well)] <- 701-l3$RSpot[grepl("B",l3$Well)]
#Add in ligand and ECMp names so they will carry through the normalization
l3$BWL <- paste(l3$Barcode,l3$Well,l3$Ligand,sep="_")
l3$SE <- paste(l3$RSpot,l3$ECMp,sep="_")
l3$BW <- paste(l3$Barcode,l3$Well,sep="_")
#Cast to get mel values by barcode_well rows and spot columns
#Coerce missing values to have near 0 proliferation signals
l3LinRatioc <- dcast(l3, BWL~SE, value.var="LinRatiomel",fill = log2(.01))
#Remove the BWL column and use it as rownames in the matrix
l3LinRatiom <- l3LinRatioc[,grep("BWL",colnames(l3LinRatioc), value=TRUE, invert=TRUE), with=FALSE]
#YLinRatio is a numeric matrix of the raw logit transformed LinRatio responses 
#of each spot extracted from the l3 dataset
YLinRatio <- matrix(unlist(l3LinRatiom), nrow=nrow(l3LinRatiom), dimnames=list(l3LinRatioc$BWL, colnames(l3LinRatiom)))

```
---
title: "MEP-LINCS `r x[["CellLine"]]` `r x[["StainingSet"]]` `r x[["Signal"]]` `r x[["Method"]]` Normalization"
date: "`r Sys.Date()`"
---

###Lineage Ratio Signal
This analysis focuses on the ratio of the median cytoplasmic intensity values of KRT19/KRT5 at each spot. The lineage ratios in this dataset have been log2 transformed into the range [-10, 10].  


```{r, eval=TRUE, fig.width=4.5, fig.height=4}


titleExpression <- expression(Lineage~Ratio~ Medians~(m["e,l"]))
plotLEHmap(l1MEPs, fill="mel", titleExpression)

titleExpression <- expression(Lineage~Ratio~~MADs~(M["e,l"]))
plotLEHmap(l1MEPs, fill="Mel", titleExpression)


```

###RUVIII with Plate as Unit of Study

In the following plots RUV-3 normalization is applied to the lineage ratio signal of all spots with the plate as the unit of study. This creates an 8x5552 matrix of spot values. The 694 spots in the A03 control wells of each plate are designated as negative controls. The faceted plots show normalizations at various k values.

```{r}
#Setup data with plate as the unit
#There are 8 'samples' with 694 controls
#Order the spot level data by plate, well, spot number
#Add in ligand and ECMp names so they will carry through the normalization
l3$WSE <- paste(l3$Well, l3$RSpot,l3$ECMp,sep="_")
#Cast to get mel values by barcode by well+Spot+ECMp
#Use the names to hold the spot contents
#Coerce missing values to have near 0 proliferation signals
l3LinRatioPlateC <- dcast(l3, Barcode~WSE, value.var="LinRatiomel",fill = log2(.01/(1-.01)))
#Remove the Barcode column and use it as rownames in the matrix
l3LinRatioPlateM <- l3LinRatioPlateC[,grep("Barcode",colnames(l3LinRatioPlateC), value=TRUE, invert=TRUE), with=FALSE]
YLinRatioPlate <- matrix(unlist(l3LinRatioPlateM), nrow=nrow(l3LinRatioPlateM), dimnames=list(l3LinRatioPlateC$Barcode, colnames(l3LinRatioPlateM)))

```

```{r}

nYLinRatioPlateList <- lapply(1:4, function(k, Y, M, cIdx, mValue, MValue){
    #browser()
    nYLinRatiom <- medianRUVIIIPlate(k, Y, M, cIdx)
    setnames(nYLinRatiom, "Value", "mel")
    nYLinRatioM <- madRUVIIIPlate(k, Y, M, cIdx)
    setnames(nYLinRatioM, "Value", "Mel")
    setkey(nYLinRatiom,Barcode,Well,ECMp)
    setkey(nYLinRatioM,Barcode,Well,ECMp)
    nYLinRatio <- merge(nYLinRatiom, nYLinRatioM)
    nYLinRatio$BW <- paste(nYLinRatio$Barcode,nYLinRatio$Well, sep="_")
    setkey(nYLinRatio,BW)
    BWL <- unique(l3[,.(BW,Ligand)])
    setkey(BWL,BW)
    nYLinRatio <- merge(nYLinRatio, BWL)
    nYLinRatio$MEP <- paste(nYLinRatio$ECMp,nYLinRatio$Ligand, sep="_")
    nYLinRatio <- nYLinRatio[,BW :=NULL]

    #Add margin values
    nYLinRatio <- addMarginValues(dt=nYLinRatio, mValue="mel",MValue="Mel")
    nYLinRatio$k <- k
    return(nYLinRatio)
}, Y=YLinRatioPlate, M=matrix(1,nrow=nrow(YLinRatioPlate)), cIdx=which(grepl("A03",colnames(YLinRatioPlate))), mValue="mel", MValue="Mel")

nYLinRatioPlatek <- rbindlist(nYLinRatioPlateList)

```


```{r, fig.height=3}
groupBy <- "ECMp"
value <- "mel-m.l"
colourBy <- "Barcode"
titleExpression=expression(Lineage~Ratio~~Centered~Medians~by~ECMp~(m["e,l"]*"-"*m[".,l"]))
p <- ggplot(l1MEPs, aes_string(x=groupBy, y=value))+
  geom_boxplot()+ 
  ggtitle(titleExpression)+
  xlab("")+ylab("")+
  #ylim(-6,4)+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
suppressWarnings(print(p))
```

```{r}

dt <- nYLinRatioPlatek

p <- ggplot(dt,aes_string(x=groupBy, y=value))+
  geom_boxplot()+ 
  ggtitle(bquote(Lineage~Ratio~~ Medians~(m["e,l"]*"-"*m[".,l"])~After~RUVIII~Normalization~with ~Plate~Unit~of~Study))+
  xlab("")+ylab("")+
  #ylim(-6,4)+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))+
facet_grid(k~., labeller = labeller(k = label_both))
suppressWarnings(print(p))
```

```{r, fig.height=3}
groupBy <- "Ligand"
value <- "mel-me."
colourBy <- "Barcode"
titleExpression=expression(Lineage~Ratio~~Centered~Medians~by~Ligand~(m["e,l"]*"-"*m["e,."]))
p <- ggplot(l1MEPs, aes_string(x=groupBy, y=value, colour=colourBy))+
  geom_boxplot()+ 
  ggtitle(titleExpression)+
  xlab("")+ylab("")+
  #ylim(-6,4)+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))
suppressWarnings(print(p))

```

```{r}

dt <- nYLinRatioPlatek

p <- ggplot(dt,aes_string(x=groupBy, y=value, colour=colourBy))+
  geom_boxplot()+ 
  ggtitle(bquote(Lineage~Ratio~~ Medians~(m["e,l"]*"-"*m["e.,."])~After~RUVIII~Normalization~with ~Plate~Unit~of~Study))+
  xlab("")+ylab("")+
  #ylim(-6,4)+
  guides(fill=FALSE)+
  theme_grey(base_size = 12, base_family = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))+
  facet_grid(k~., labeller = labeller(k = label_both))
suppressWarnings(print(p))

```


```{r, fig.width=5, fig.height=4}

fill <- "mel"
titleExpression <- expression(Lineage~Ratio~~ Medians~(m["e,l"]))
dt <- l1MEPs
limits <- quantile(dt[[fill]], probs=c(.02, .98))
                 
p <- ggplot(dt, aes_string(x="Ligand", y="ECMp", fill = fill))+
  geom_tile()+
  scale_fill_gradient(low="white",high="red",oob = scales::squish,limits=limits)+
  ggtitle(titleExpression)+
  xlab("")+ylab("")+
  #guides(fill=FALSE)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)),panel.grid.major = element_line(linetype = 'blank'),panel.background = element_rect(fill = "dimgray"))
suppressWarnings(print(p))
```

```{r, fig.width=4.5}

dt <- nYLinRatioPlatek

p <- ggplot(dt, aes_string(x="Ligand", y="ECMp", fill = fill))+
  geom_tile()+
  scale_fill_gradient(low="white",high="red",oob = scales::squish, limits=limits)+
   ggtitle((bquote(Lineage~Ratio~~ Medians~(m["e,l"]*"-"*m["e.,."])~After~RUVIII~Normalization~with ~Plate~Unit~of~Study)))+
  facet_grid(k~., labeller = labeller(k = label_both))+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.4)), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)),panel.grid.major = element_line(linetype = 'blank'),panel.background = element_rect(fill = "dimgray"))
suppressWarnings(print(p))

```


```{r, fig.width=5, fig.height=4}

fill <- "Mel"
titleExpression <- expression(Lineage~Ratio~~ MADs~(M["e,l"]))
dt <- l1MEPs
limits <- quantile(dt[[fill]], probs=c(.02, .98))
                 
p <- ggplot(dt, aes_string(x="Ligand", y="ECMp", fill = fill))+
  geom_tile()+
  scale_fill_gradient(low="white",high="red",oob = scales::squish,limits=limits)+
  ggtitle(titleExpression)+
  xlab("")+ylab("")+
  #guides(fill=FALSE)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)),panel.grid.major = element_line(linetype = 'blank'),panel.background = element_rect(fill = "dimgray"))
suppressWarnings(print(p))
```

```{r, fig.width=4.5}

dt <- nYLinRatioPlatek

p <- ggplot(dt, aes_string(x="Ligand", y="ECMp", fill = fill))+
  geom_tile()+
  scale_fill_gradient(low="white",high="red",oob = scales::squish, limits=limits)+
   ggtitle((bquote(Lineage~Ratio~~ MADs~(M["e,l"]*"-"*M["e.,."])~After~RUVIII~Normalization~with ~Plate~Unit~of~Study)))+
  facet_grid(k~., labeller = labeller(k = label_both))+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.4)), plot.title = element_text(size = rel(.7)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)),panel.grid.major = element_line(linetype = 'blank'),panel.background = element_rect(fill = "dimgray"))
suppressWarnings(print(p))

```
